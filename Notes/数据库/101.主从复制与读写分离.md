# 主从复制

## 基本原理

![image-20200812021730324](assets/image-20200812021730324.png)

主要涉及三个线程：binlog 线程、I/O 线程和 SQL 线程。

- **binlog 线程**  ：负责将主服务器上的数据更改写入二进制日志（Binary log）中。
- **I/O 线程**  ：负责从主服务器上读取二进制日志，并写入从服务器的中继日志（Relay log）。
- **SQL 线程**  ：负责读取中继日志，解析出主服务器已经执行的数据更改并在从服务器中重放（Replay）。

1)master将改变记录到二进制日志（binary log）。

这些记录过程叫做二进制日志事件，binary log events；

不管使用何种存储引擎，在server层都可以开启binlog日志功能。binlog会记录所有的逻辑操作，并且是采取追加写的形式，将写操作命令，记录在一个二进制文件中。因此binlog日志通常用于恢复数据，或者是主从复制。

2)slave将master的binary log events拷贝到它的中继日志（relay log）；

3)slave重做中继日志中的事件，将改变应用到自己的数据库中。MySQL复制是异步的且串行化的

复制的基本原则

1) 每个slave只有一个master
2) 每个slave只能有一个唯一的服务器ID
3) 每个master可以有多个salve

默认binlog文件会保存在/var/lib/mysql目录中，以mysql-bin.xxxx开头。可以使用工具mysqlbinlog进行查看。

mysql的主从复制为设置一台mysql服务实例为主机，另一台为从机。主机的数据可以实时同步到从机。

## 一主一从配置步骤

主机：hadoop100

从机：hadoop101

步骤如下：

①修改主机的my.cnf配置文件

```
[mysqld]
server-id=1    #server实例的id
log-bin=/var/lib/mysql/mysql-bin   #log-bin文件存储位置
binlog_format=ROW  # 设置log-bin格式 STATEMENT   ROW  MIXED  

#可选的配置
binlog-ignore-db=mysql  # 设置不要复制的数据库
binlog-do-db=xxx  # 设置需要复制的主数据库名字
```

编辑完配置文件后，mysql服务需要重启。

②修改从机的my.cnf配置文件

```
[mysqld]
server-id=2    #server实例的id
relay-log=mysql-relay   #中继日志
```

编辑完配置文件后，mysql服务需要重启。

③在主机上建立账户并授权从机

使用root用户登录主机，在命令行执行如下命令。

```sql
GRANT replication slave ON *.* TO 'slave'@'%' IDENTIFIED BY '123456';
```

③在主机执行show master status查看主机的binlog日志信息

```sql
show master status ;
```

![image-20200812022614043](assets/image-20200812022614043.png)

记录binlog的file和position属性，不要再操作主机MySQL，防止主机的File和Position值发生变化。

④配置从机

使用mysql客户端连接从机服务，如果之前配置过主从，需要先执行stop slave停止主从关系。

之后输入以下命令：

```shell
mysql> CHANGE MASTER TO MASTER_HOST='192.168.202.100',
        MASTER_USER='slave',
        MASTER_PASSWORD='123456',
        MASTER_LOG_FILE='mysql-bin.000001',
        MASTER_LOG_POS=154;
```

配置完成后，在从机的/var/lib/mysql目录下会产生一个名为master.info的主机配置信息文件。

⑤启动从机

```sql
mysql> start slave;
```

查看主从复制状态

```sql
mysql> show slave status\G;
```

主要查看两个参数:

Slave_IO_Running: Yes

Slave_SQL_Running: Yes

![image-20200810223920825](assets/image-20200810223920825.png)

⑥测试主从

在主机hadoop100上新建库、新建表、插入数据，查看从机是否复制

⑦在从机hadoop101停止主从

```sql
mysql> stop slave ;
```

# 读写分离

主服务器处理写操作以及实时性要求比较高的读操作，而从服务器处理读操作。

读写分离能提高性能的原因在于：

- 主从服务器负责各自的读和写，极大程度缓解了锁的争用；
- 从服务器可以使用 MyISAM，提升查询性能以及节约系统开销；
- 增加冗余，提高可用性。

读写分离常用代理方式来实现，代理服务器接收应用层传来的读写请求，然后决定转发到哪个服务器。

![](assets/master-slave-proxy.png)