## 存储过程

存储过程(procedure)是一一系列SQL语句的批处理，调用存储过程时，就会执行这些SQL语句。

使用存储过程的好处：

- 代码封装，保证了一定的安全性。
- 代码复用；
- 由于是预先编译，因此具有很高的性能。

命令行中创建存储过程需要自定义分隔符，因为命令行是以 ; 为结束符，而存储过程中也包含了分号，因此会错误把这部分分号当成是结束符，造成语法错误。

存储过程可以接受参数：

- in: 传入参数
- out： 返回参数
- inout：参数即可传入也可返回

给变量赋值都需要用 select into 语句。每次只能给一个变量赋值，不支持集合的操作。

```sql
--创建过程
delimiter //

create procedure myprocedure( out ret int )
    begin
        declare y int;
        select sum(col1)
        from mytable
        into y;
        select y*y into ret;
    end //

delimiter ;

--调用过程
call myprocedure(@ret);
select @ret;

--删除过程
drop procedure myprocedure;
```

示例：

创建含参存储过程：

```sql
delimiter //
create procedure p1(
	in i1 int,
	in i2 int,
	inout i3 int,
	out r1 int)
begin
	declare temp1 int;
	declare temp2 int default 0;
	set temp1 = 1;
	set r1 = i1 + i2 + temp1 +temp2;
	set i3 = i3 + 100;
end //
delimiter ;
```

执行含参存储过程：

```sql
set @t1 = 4;
set @t2 = 0;
call p1(1,2,@t1,@t2);
select @t1,@t2;
```

存储过程可以嵌套事务和游标。
存储过程可以动态执行防止SQL注入：

```sql
delimiter //
create procedure p4(in nid int)
begin
	prepare prod from 'select * from student where sid > ?';
	execute prod using @nid;
	deallocate prepare prod;
end//
delimiter ;
```

## 游标

在存储过程中使用游标可以对一个结果集进行移动遍历。

游标主要用于交互式应用，其中用户需要对数据集中的任意行进行浏览和修改。

使用游标的四个步骤：

1. 声明游标，这个过程没有实际检索出数据；
2. 打开游标；
3. 取出数据；
4. 关闭游标；

```mysql
delimiter //
create procedure myprocedure(out ret int)
    begin
        declare done boolean default 0;

        declare mycursor cursor for
        select col1 from mytable;
        # 定义了一个 continue handler，当 sqlstate '02000' 这个条件出现时，会执行 set done = 1
        declare continue handler for sqlstate '02000' set done = 1;

        open mycursor;

        repeat
            fetch mycursor into ret;
            select ret;
        until done end repeat;

        close mycursor;
    end //
 delimiter ;
```