## 是什么

MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阈值的语句，具体指运行时间超过long_query_time(默认10s)值的SQL，则会被记录到慢查询日志中。

## 开启慢查询日志

默认情况下，MySQL数据库没有开启慢查询日志，需要我们手动来设置这个参数。

当然，如果不是调优需要的话，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件

1)查看慢查询日志是否开启

```sql
mysql> show variables like "%slow_query_log%";
```

![image-20200812024356383](assets/image-20200812024356383.png)

2)开启慢查询日志

```sql
mysql> set global slow_query_log =1 ;
```

![image-20200812024418128](assets/image-20200812024418128.png)

因为slow_query_log是一个全局变量，因此需要加上 global关键字.

如果要永久生效,需要修改/etc/my.cnf配置文件

```shell
[mysqld]
slow_query_log =1   #开启慢查询
slow_query_log_file=/var/lib/mysql/atguigu-slow.log  #慢查询日志位置
```

3)多久算慢查询

这个是由参数long_query_time控制，默认情况下long_query_time的值为10秒，MySQL会将执行时间大于 long_query_time的SQL记录到日志中。

```sql
mysql> show variables like "%long_query_time%";
```

## 查看慢查询日志

1)跟随查询

```sql
[root@hadoop205 ~]# tail -f /var/lib/mysql/xxxx.log
```

2)通过Mysql方式查看

```sql
mysql> show status like '%slow_queries%';
```

![image-20200812024613678](assets/image-20200812024613678.png)

3)日志分析工具mysqldumpslow

参数介绍

|    |                                        |
| -- | -------------------------------------- |
| -s | 按照何种方式排序                       |
| c  | 访问次数                               |
| l  | 锁定时间                               |
| r  | 返回记录                               |
| t  | 查询时间                               |
| al | 平均锁定时间                           |
| ar | 平均返回记录数                         |
| at | 平均查询时间                           |
| -t | 返回前面多少条的数据                   |
| -g | 后边搭配一个正则表达式，大小写不敏感的 |

工作常用参考

| 得到返回记录集最多的10个SQL                                      | mysqldumpslow -s r -t 10 日志文件                  |
| ---------------------------------------------------------------- | -------------------------------------------------- |
| 得到访问次数最多的10个SQL                                        | mysqldumpslow -s c -t 10 日志文件                  |
| 得到按照时间排序的前10条里面含有左连接的查询语句                 | mysqldumpslow -s t -t 10 -g  "left join"  日志文件 |
| 建议在使用这些命令时结合 \|  和more 使用 ，否则有可能出现爆屏情况 | mysqldumpslow -s r -t 10  日志文件 \| more          |

## 如何优化