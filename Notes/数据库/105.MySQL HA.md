## 12.1 HA

HA是High Available缩写，是双机集群系统简称，指高可用性集群，是保证业务连续性的有效解决方案，一般有两个或两个以上的节点，且分为活动节点及备用节点.

简单来说就是7*24小时不间断对外提供服务.

## 12.2 MySQL 主从复制

MySQL的HA离不开其主从复制的技术。主从复制是指一台服务器充当主数据库服务器（master），另一台或多台服务器充当从数据库服务器（slave），从服务器（slave）自动向主服务器（master）同步数据。实现MySQL的HA，需使两台服务器互为主从关系。

## 12.3 Keepalived

Keepalived是基于VRRP（Virtual Router Redundancy Protocol，虚拟路由器冗余协议）协议的一款高可用软件。Keepailived有一台主服务器（master）和多台备份服务器（backup），在主服务器和备份服务器上面部署相同的服务配置，使用一个虚拟IP地址对外提供服务，当主服务器出现故障时，虚拟IP地址会自动漂移到备份服务器。

## 12.4 互为主从

在第11章主从复制中的一主一从的基础之上，搭建互为主从.

### 12.4.1 配置主机hadoop101(原从)

1) ```
      修改 /etc/my.cnf
   ```

```shell
[mysqld]
#开启binlog
log_bin = /var/lib/mysql/mysql-bin
binlog_format=ROW  # 设置log-bin格式 STATEMENT   ROW  MIXED
server-id=2    #server实例的id
relay-log=mysql-relay   #中继日志
```

2) ```
      重启hadoop101的MySQL服务
   ```
3) ```
      在主机hadoop101上建立账户并授权从机slave
   ```

```sql
mysql> GRANT REPLICATION SLAVE ON *.* TO 'slave'@'192.168.202.100' IDENTIFIED BY '123456';
```

4) ```
      查看hadoop101 MySQL的master状态
   ```

```sql
mysql> show master status;
```

![image-20200812023507808](assets/image-20200812023507808.png)

注意:记录下File 和Position的值，切记不要再操作主机MySQL，防止主机的File和Position值发生变化

### 12.4.2 配置从机hadoop100(原主)

1) ```
      修改hadoop100上 /etc/my.cnf
   ```

```shell
[mysqld]
#MySQL服务器唯一id
server_id = 1

#开启binlog
log_bin = mysql-bin

#开启slave中继日志
relay-log=mysql-relay
```

2) ```
      重启 hadoop100上的MySQL服务
   ```
3) ```
      在从机hadoop100上配置需要复制的主机
   ```

```sql
CHANGE MASTER TO MASTER_HOST='主机IP',
MASTER_USER='主机创建好的用户',
MASTER_PASSWORD='密码',
MASTER_LOG_FILE='File名1字',
MASTER_LOG_POS=Position数字;

mysql> CHANGE MASTER TO MASTER_HOST='192.168.202.101',
        MASTER_USER='slave',
        MASTER_PASSWORD='123456',
        MASTER_LOG_FILE='mysql-bin.000001',
        MASTER_LOG_POS=452
```

4) ```
      在从机hadoop100上启动主从
   ```

```sql
mysql> start slave ;
```

5) ```
      在从机hadoop100上查看slave状态
   ```

```sql
mysql> show slave status\G;
```

主要查看两个参数:

Slave_IO_Running: Yes

Slave_SQL_Running: Yes

6) ```
      测试主从
   ```

在主机hadoop101上创建库，创建表，插入数据,查看从机是否复制

7)在从机hadoop100上停止主从

```sql
mysql> stop slave;
```

## 12.5 搭建MySQL HA

### 12.5.1 安装 Keepalived

1)分别在hadoop100 和 hadoop101上安装 keepalived

```shell
[root@hadoop100 ~] yum install -y keepalived
[root@hadoop101 ~] yum install -y keepalived
```

2)分别在hadoop100 和 hadoop101上配置 /etc/keepalived/keepalived.conf

hadoop100

```shell
! Configuration File for keepalived
global_defs {
    router_id MySQL-HA
}
vrrp_instance VI_1 {
    state master #初始状态
    interface eth0 #网卡
    virtual_router_id 51 #虚拟路由id
    priority 100 #优先级
    advert_int 1 #Keepalived心跳间隔
    nopreempt #只在高优先级配置，原master恢复之后不重新上位
    authentication {
        auth_type PASS #认证相关
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.202.222 #虚拟ip
    }
} 

#声明虚拟服务器
virtual_server 192.168.202.222 3306 {
    delay_loop 6
    persistence_timeout 30
    protocol TCP
    #声明真实服务器
    real_server 192.168.202.100 3306 {
        notify_down /var/lib/mysql/killkeepalived.sh #真实服务故障后调用脚本
        TCP_CHECK {
            connect_timeout 3 #超时时间
            nb_get_retry 1 #重试次数
            delay_before_retry 1 #重试时间间隔
        }
    }
}
```

hadoop101

```shell
! Configuration File for keepalived
global_defs {
    router_id MySQL-HA
}
vrrp_instance VI_1 {
    state master #初始状态
    interface eth0 #网卡
    virtual_router_id 51 #虚拟路由id
    priority 100 #优先级
    advert_int 1 #Keepalived心跳间隔
    nopreempt #只在高优先级配置，原master恢复之后不重新上位
    authentication {
        auth_type PASS #认证相关
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.202.222 #虚拟ip
    }
} 

#声明虚拟服务器
virtual_server 192.168.202.222 3306 {
    delay_loop 6
    persistence_timeout 30
    protocol TCP
    #声明真实服务器
    real_server 192.168.202.101 3306 {
        notify_down /var/lib/mysql/killkeepalived.sh #真实服务故障后调用脚本
        TCP_CHECK {
            connect_timeout 3 #超时时间
            nb_get_retry 1 #重试次数
            delay_before_retry 1 #重试时间间隔
        }
    }
}
```

3)分别在hadoop100和 hadoop101上编辑脚本文件 /var/lib/mysql/killkeepalived.sh

```sh
#! /bin/bash
service keepalived stop
```

赋予脚本执行权限

```shell
chmod 777 /var/lib/mysql/killkeepalived.sh
```

4)分别在hadoop100 和 hadoop101上启动 Keepalived服务

```shell
[root@hadoop100 ~] service keepalived start 
[root@hadoop101 ~] service keepalived start 
```

5)测试MySQL HA