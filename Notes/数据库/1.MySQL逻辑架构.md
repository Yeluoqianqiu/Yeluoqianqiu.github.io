## MySQL体系架构

![](assets/20130611080522375-20210325204022-e3amsb8.jfif)

和其它数据库相比，MySQL有点与众不同，它的架构可以在多种不同场景中应用并发挥良好作用。主要体现在存储引擎的架构上，插件式的存储引擎架构将查询处理和其它的系统任务以及数据的存储提取相分离。这种架构可以根据业务的需求和实际需要选择合适的存储引擎。各层介绍：

### 连接层

客户端与各种语言进行对接的接口，支持各种协议，例如常见的 JDBC、Python等。

### 服务层

MySQLServer层主要包括连接池、管理服务工具集、SQL接口、解析器、查询优化器和缓存。

1. 连接池：负责处理存储数据库与客户端创建的连接，线程池资源管理，一个线程负责管理一个连接。
2. 管理服务工具集：包括备份恢复、安全管理、集群管理服务和工具。
3. SQL接口：负责接收客户端发送的各种 SQL 语句，比如 DML、DDL 和存储过程等。
4. 解析器：对 SQL 语句进行语法解析生成解析树。
5. 查询优化器：会根据解析树生成执行计划，并选择合适的索引，然后按照执行计划执行 SQL 语言并与各个存储引擎交互。
6. 高速缓存与缓冲区：保存历史查询的缓存记录，比如：InnoDB存储的BufferPool。

### 引擎层

存储引擎层，存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API与存储引擎进行通信。不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取。

常见的引擎包括MyISAM、InnoDB，以及支持归档的Archive和内存的Memory等。MySQL是插件式的存储引擎，只要正确定义与MySQLServer交互的接口，任何引擎都可以访问MySQL。

### 存储层

存储层存储具体的物理文件，包括二进制日志、数据文件、错误日志、慢查询日志、全日志、redo/undo 日志等。

### 一条SQL SELECT语句的执行过程：

![](assets/SQL语句的执行流程.png)

## MyISAM 和InnoDB

### InnoDB

InnoDB是 MySQL 默认的事务型存储引擎，特点如下：

- **四个隔离级别**，默认**可重复读**。可重复读+MVCC+ Next-Key Locking 防止幻读
- 主索引是**聚簇索引**，底层B+树，叶结点保存全量数据。
- 真正的**在线热备份**。其它存储引擎不支持在线热备份，要获取一致性视图需要停止对所有表的写入，而在读写混合场景中，停止写入可能也意味着停止读取。
- 其他内部优化：从磁盘读取数据时采用的**可预测性读**、能够加快读操作并且自动创建的**自适应哈希**索引、能够加速插入操作的**插入缓冲区**等。

### MyISAM

不支持事务。

只支持表锁，不支持行锁，读取时会对需要读到的所有表加共享锁，写入时则对表加排它锁。

但在表有读取操作的同时，也可以往表中插入新的记录，这被称为并发插入（CONCURRENT INSERT）。

可以手工或者自动执行检查和修复操作，但是和事务恢复以及崩溃恢复不同，可能导致一些数据丢失，而且修复操作是非常慢的。

如果指定了 DELAY_KEY_WRITE 选项，在每次修改执行完成时，不会立即将修改的索引数据写入磁盘，而是会写到内存中的键缓冲区，只有在清理键缓冲区或者关闭表的时候才会将对应的索引块写入磁盘。这种方式可以极大的提升写入性能，但是在数据库或者主机崩溃时会造成索引损坏，需要执行修复操作。

**对于只读数据，或者表比较小、可以容忍修复操作，依然可以使用它。**

### 比较

|          | MyISAM                                                 | InnoDB                                   |
| -------- | ------------------------------------------------------ | ---------------------------------------- |
| 事务     | 不支持                                                 | 支持                                     |
| 外键     | 不支持                                                 | 支持                                     |
| 行表锁   | 只有表锁，即使操作一条记录也锁整张表，不适合高并发场景 | 支持行锁，操作时只锁一行，适合高并发场景 |
| 缓存     | 只缓存索引，不缓存数据                                 | 既缓存索引，也缓存数据，占用内存较高     |
| 热备     | 不支持                                                 | 支持在线热备份                           |
| 适用场景 | 读取性能高，适合单机只读数据                           | 适合需要并发、事务的场景                 |

show engines:查看所有的数据库引擎

![image-20200810222757312](assets/image-20200810222757312.png)

show variables like '%storage_engine%' 查看默认的数据库引擎

```shell
mysql> show variables like '%storage_engine%';
+----------------------------+--------+
| Variable_name              | Value  |
+----------------------------+--------+
| default_storage_engine     | InnoDB |
| default_tmp_storage_engine | InnoDB |
| storage_engine             | InnoDB |
+----------------------------+--------+
```